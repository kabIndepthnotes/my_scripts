#!/bin/bash
prompt="Here is unicode text that contains outputted latex math mode code from a pdf, please convert this line from unicode back to it's original latex code, BE TERSE, do not include any other response. Become a machine that inputs unicode text and outputs latex math mode code."

# staged diff â†’ raw string escaped for JSON
math_code=$(xsel -b) # todo take from standard input

# build JSON in OpenRouter format
json_payload=$(
  jq -n \
    --arg prompt "$prompt" \
    --arg gdiff "$math_code" \
    '{
      model: "google/gemini-2.5-flash-lite",
      messages: [
        {
          role: "user",
          content: [
            {
              type: "text",
              text: ($prompt + "\n\n" + $gdiff)
            }
          ]
        }
      ]
    }'
)

# send request
res=$(
  curl -s https://openrouter.ai/api/v1/chat/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $OPENROUTER_API_KEY" \
    -d "$json_payload"
)

# extract model text output
echo "$res" | jq -r '.choices[0].message.content'
